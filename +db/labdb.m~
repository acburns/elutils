classdef labdb < handle
    
    
    properties (SetAccess=private,GetAccess=private)
        dbconn = [];
        config = [];
    end
    
    methods
        function obj = labdb(host, user, passwd, db)
            if nargin == 0
                obj.config = readDBconf();
            elseif naragin == 1
                obj.config = readDBconf(host);
            else
                obj.config.host = host;
                obj.config.user = user;
                obj.config.passwd = passwd;
                if nargin > 3
                    obj.config.db = db;
                else
                    obj.config.db = 'met';
                end
                
                
            end
            
            checkConnection(obj);
            
        end
        
        function host = getHost(obj)
            host = obj.config.host;
        end
        
        function user = getUser(obj)
            user = obj.config.user;
        end
        
        function execute(obj, sqlstr, args)
            query(obj, sqlstr, args)
        end
        function out = query(obj, sqlstr, args) 
	    	sqlquery = sqlstr;
            cur = obj.dbconn.exec(sqlquery);
            if cur.message
            data = fetch(cur);
            out = data.Data;
            close(cur);
           
        end
        
        function checkConnection(obj)
            if isempty(obj.dbconn)
                obj.dbconn = database(obj.config.db,obj.config.user,obj.config.passwd,'Vendor','MySQL',...
                'Server',obj.config.host);
            elseif ~conn.isopen
                obj.dbconn = database(obj.config.db,obj.config.user,obj.config.passwd,'Vendor','MySQL',...
                'Server',obj.config.host);
            end
        end
        
        function out = foo(obj)
            cur = obj.dbconn.exec('explain fac.sensors');
            out = cur.fetchall();
        end
        
    end
end


function cfg = readDBconf(cfgname)
% A private function to help the labdb class read credentials from the
% .dbconf file in the user's home directory.

cfg.db = ''; % In case db is not passed in set it by default to nothing.
if nargin == 0
    
    cfgname = 'client';
end
import java.lang.*;
cusr=System.getProperty('user.home');
cfgfile = fullfile(char(cusr), '.dbconf');

if ~exist(cfgfile,'file')
    error('labdb:dbconf','.dbconf file not found in home directory');
end

fid = fopen(cfgfile);
start = false;
while 1
    tline = fgetl(fid);
    if ~ischar(tline), break, end
    
    
    if start
        if numel(tline)==0 || tline(1) == '['
            % Starting another section.
            break
        end
        [field, value] = strtok(tline,'=');
        
        cfg.(strtrim(field)) = strtrim(value(2:end));
    end
    
    if strcmpi(tline, ['[' cfgname ']'])
        start = true;
    end
end
fclose(fid);
end


